### TaskCreator (Quarkus-only) Justfile
APP_NAME       := "timersession-quarkus"
QUARKUS_IMAGE   := "timersession-quarkus:latest"
QUARKUS_PORT    := "9080"               # Quarkus internal HTTP
HOST_PORT      := "10052"               # Host port to map to Quarkus internal HTTP

build:
	docker build -f Dockerfile -t {{QUARKUS_IMAGE}} .
	@echo "[INFO] Built image: {{QUARKUS_IMAGE}}"

rebuild:
	docker build --no-cache -f Dockerfile -t {{QUARKUS_IMAGE}} .
	@echo "[INFO] Rebuilt image (no cache): {{QUARKUS_IMAGE}}"

up: build
	@if docker ps --all --quiet --filter name=^/timersession-quarkus$ | grep -q .; then \
		echo "[INFO] Removing existing container"; \
		docker rm -f timersession-quarkus >/dev/null; \
	fi
	docker run -d --name timersession-quarkus -p {{HOST_PORT}}:{{QUARKUS_PORT}} {{QUARKUS_IMAGE}}
	@echo "[INFO] Started timersession-quarkus, waiting for app to start..."
	@until docker logs {{APP_NAME}} 2>&1 | grep -q '[io.quarkus].*started in .*Listening on:'; do sleep 1; done
	@echo "[INFO] Quarkus app started, port {{HOST_PORT}} is ready."

logs:
	docker logs -f timersession-quarkus

down:
	- docker rm -f timersession-quarkus
	@echo "[INFO] Container removed (if it existed)"

# Clean up
clean: down
    docker rmi {{APP_NAME}}
    @echo "[INFO] Image removed (if it existed)"

test: up
    @docker exec {{APP_NAME}} sh -c 'python3 /app/smoke.py'

local:
	./mvnw clean package quarkus:run
